<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tirage au sort de NoÃ«l ðŸŽ„</title>
<style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 2em; background-color: #f9f3f0; transition: background-color 1s ease; }
    h1 { color: #d32f2f; text-shadow: 1px 1px 2px #fff; }
    button { padding: 0.5em 1em; font-size: 1em; margin-top: 1em; cursor: pointer; border-radius: 8px; border: none; background: #d32f2f; color: white; transition: transform 0.2s; }
    button:hover { transform: scale(1.05); background: #b71c1c; }
    select { padding: 0.5em; font-size: 1em; border-radius: 6px; }
    #result { margin-top: 2em; font-size: 1.5em; color: #2e7d32; font-weight: bold; min-height: 2em; }
    canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 9999; }

    /* âœ¨ Effet magique sur le rÃ©sultat final */
    .magic-reveal {
        animation: popIn 0.6s ease forwards, glow 1.5s ease-in-out infinite alternate;
    }

    @keyframes popIn {
        0% { transform: scale(0.2); opacity: 0; }
        70% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(1); }
    }

    @keyframes glow {
        from { text-shadow: 0 0 5px #fff, 0 0 10px #d32f2f, 0 0 20px #ff5252; }
        to { text-shadow: 0 0 10px #fff, 0 0 20px #ff1744, 0 0 30px #ff5252; }
    }
</style>
</head>
<body>
<h1>Tirage au sort de NoÃ«l ðŸŽ„</h1>

<p>Choisis ton nom :</p>
<select id="yourName"></select>
<br>
<button id="drawBtn">Tirer au sort</button>
<button id="resetBtn">RÃ©initialiser le tirage</button>

<div id="result"></div>
<canvas id="confetti"></canvas>

<!-- Musique de NoÃ«l -->
<audio id="bgMusic" loop>
  <source src="christmas-party-time-249613.mp3" type="audio/mpeg">
  Ton navigateur ne supporte pas la musique de fond.
</audio>
<button id="musicToggle" style="position: fixed; bottom: 10px; left: 10px; z-index: 10001; padding:5px 10px;">ðŸ”Š Musique</button>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ====== CONFIGURATION FIREBASE ======
const firebaseConfig = {
    apiKey: "AIzaSyAFX3QpLLOw2f0JZMSOEobFk_XzRTmBmfA",
    authDomain: "tirageausortnoel2025.firebaseapp.com",
    databaseURL: "https://tirageausortnoel2025-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "tirageausortnoel2025",
    storageBucket: "tirageausortnoel2025.firebasestorage.app",
    messagingSenderId: "920614742305",
    appId: "1:920614742305:web:54930654b2782a07863660"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ====== LISTE DES INVITÃ‰S ======
const guests = ["Martin", "LÃ©naÃ«lle", "Emilie", "Patricia", "Michel", "Quentin", "Tan","Jean-Michel","Lionel","Antoine","Marie","Didier"];

// ====== FUNCTIONS ======
function updateDropdown(alreadyDrawn) {
    const select = document.getElementById("yourName");
    select.innerHTML = '';
    guests.forEach(name => {
        if (!alreadyDrawn || !alreadyDrawn[name]) {
            let option = document.createElement("option");
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
        }
    });
}

// Ã‰coute la base de donnÃ©es pour la synchro
db.ref('tirage').on('value', snapshot => {
    const data = snapshot.val() || {};
    updateDropdown(data.alreadyDrawn);
});

// ====== TIRAGE AVEC ANIMATION SUSPENSE ======
document.getElementById("drawBtn").addEventListener("click", async () => {
    const select = document.getElementById("yourName");
    const yourName = select.value;
    if (!yourName) return alert("Choisis ton nom.");

    const snap = await db.ref('tirage').get();
    const data = snap.val() || {};
    const alreadyDrawn = data.alreadyDrawn || {};
    const drawnFor = data.drawnFor || {};

    let possible = guests.filter(name => name !== yourName && !Object.values(drawnFor).includes(name));
    if (possible.length === 0) {
        document.getElementById("result").textContent = "DÃ©solÃ©, plus personne Ã  tirer.";
        return;
    }

    const resultDiv = document.getElementById("result");

    // ----- ANIMATION SUSPENSE -----
    function suspenseAnimation(possible, finalCallback) {
        let startTime = Date.now();
        let duration = 2000;

        function animate() {
            let elapsed = Date.now() - startTime;
            if (elapsed >= duration) {
                let index = Math.floor(Math.random() * possible.length);
                let drawn = possible[index];
                finalCallback(drawn);
                return;
            }

            let randomName = guests[Math.floor(Math.random() * guests.length)];
            resultDiv.textContent = `ðŸŽ ${randomName} ðŸŽ`;
            resultDiv.style.color = `hsl(${Math.random() * 360}, 100%, 40%)`;
            resultDiv.style.fontSize = 20 + Math.random() * 15 + "px";

            let progress = elapsed / duration;
            let interval = 50 + progress * 200;
            setTimeout(animate, interval);
        }
        animate();
    }

    suspenseAnimation(possible, (drawn) => {
        alreadyDrawn[yourName] = true;
        drawnFor[yourName] = drawn;
        db.ref('tirage').set({alreadyDrawn, drawnFor});

        resultDiv.textContent = `Tu offres un cadeau Ã  : ${drawn} ðŸŽ`;
        resultDiv.classList.add("magic-reveal"); // âœ¨ effet magique ajoutÃ© ici
        launchConfetti();

        // Petite transition de fond festive
        document.body.style.backgroundColor = "#fff0f0";
        setTimeout(() => document.body.style.backgroundColor = "#f9f3f0", 2000);
    });
});

// ====== RÃ‰INITIALISER AVEC MOT DE PASSE ======
document.getElementById("resetBtn").addEventListener("click", () => {
    const code = prompt("ðŸŽ… Entre le mot de passe pour rÃ©initialiser :");
    if (code !== "noel2025") {
        alert("â›” Mot de passe incorrect !");
        return;
    }
    if (!confirm("Veux-tu vraiment tout rÃ©initialiser ?")) return;
    db.ref('tirage').set({alreadyDrawn: {}, drawnFor: {}});
    document.getElementById("result").textContent = "";
    alert("âœ… Tirage rÃ©initialisÃ© !");
});

// ====== CONFETTIS ======
const canvas = document.getElementById("confetti");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let confettis = [];

function createConfetti() {
    for (let i = 0; i < 150; i++) {
        confettis.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height - canvas.height,
            r: Math.random() * 6 + 4,
            d: Math.random() * 20 + 10,
            color: `hsl(${Math.random()*360}, 100%, 50%)`,
            tilt: Math.random() * 10 - 10,
            tiltAngleIncremental: Math.random() * 0.07 + 0.05,
            tiltAngle: 0
        });
    }
}

function drawConfetti() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    confettis.forEach((c, i) => {
        ctx.beginPath();
        ctx.lineWidth = c.r / 2;
        ctx.strokeStyle = c.color;
        ctx.moveTo(c.x + c.tilt + c.r / 4, c.y);
        ctx.lineTo(c.x + c.tilt, c.y + c.tilt + c.r / 4);
        ctx.stroke();
        c.tiltAngle += c.tiltAngleIncremental;
        c.y += (Math.cos(c.d) + 3 + c.r / 2) / 2;
        c.tilt = Math.sin(c.tiltAngle) * 15;
        if (c.y > canvas.height) confettis.splice(i, 1);
    });
}

function launchConfetti() {
    confettis = [];
    createConfetti();
    let confettiInterval = setInterval(() => {
        drawConfetti();
        if (confettis.length === 0) clearInterval(confettiInterval);
    }, 20);
}

window.addEventListener("resize", () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});

// ====== NEIGE ANIMÃ‰E ======
function createSnowflake() {
    const snowflake = document.createElement("div");
    snowflake.classList.add("snowflake");
    snowflake.textContent = "â„ï¸";
    snowflake.style.left = Math.random() * 100 + "vw";
    snowflake.style.animationDuration = 5 + Math.random() * 5 + "s";
    snowflake.style.opacity = Math.random();
    snowflake.style.fontSize = 10 + Math.random() * 20 + "px";
    document.body.appendChild(snowflake);
    setTimeout(() => snowflake.remove(), 10000);
}
setInterval(createSnowflake, 200);

// ====== MUSIQUE DE FOND ======
const bgMusic = document.getElementById("bgMusic");
const musicToggle = document.getElementById("musicToggle");
window.addEventListener("click", () => {
    if (bgMusic.paused) bgMusic.play().catch(() => {});
}, { once: true });
musicToggle.addEventListener("click", () => {
    if (bgMusic.paused) {
        bgMusic.play();
        musicToggle.textContent = "ðŸ”‡ Musique";
    } else {
        bgMusic.pause();
        musicToggle.textContent = "ðŸ”Š Musique";
    }
});
</script>

<style>
.snowflake {
    position: fixed;
    top: -2em;
    z-index: 10000;
    pointer-events: none;
    animation-name: fall;
    animation-timing-function: linear;
}
@keyframes fall { to { transform: translateY(110vh); } }

#version {
    position: fixed;
    bottom: 10px;
    right: 10px;
    color: #b71c1c;
    font-size: 0.9em;
    background: rgba(255, 255, 255, 0.8);
    padding: 5px 10px;
    border-radius: 10px;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
    font-weight: bold;
}
</style>

<div id="version"></div>
<script>
  const version = "v1.0.6"; // ðŸŽ… nouvelle version avec effet magique !
  document.getElementById("version").textContent = "Version " + version;
</script>

</body>
</html>
