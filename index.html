<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tirage au sort de Noël 🎄</title>
<style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 2em; background-color: #f9f3f0; }
    h1 { color: #d32f2f; }
    button { padding: 0.5em 1em; font-size: 1em; margin-top: 1em; cursor: pointer; }
    select { padding: 0.5em; font-size: 1em; }
    #result { margin-top: 2em; font-size: 1.5em; color: #2e7d32; font-weight: bold; min-height: 2em; }
    canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 9999; }
</style>
</head>
<body>
<h1>Tirage au sort de Noël 🎄</h1>

<p>Choisis ton nom :</p>
<select id="yourName"></select>
<br>
<button id="drawBtn">Tirer au sort</button>
<button id="resetBtn">Réinitialiser le tirage</button>

<div id="result"></div>
<canvas id="confetti"></canvas>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ====== CONFIGURATION FIREBASE ======
const firebaseConfig = {
    apiKey: "AIzaSyAFX3QpLLOw2f0JZMSOEobFk_XzRTmBmfA",
    authDomain: "tirageausortnoel2025.firebaseapp.com",
    databaseURL: "https://tirageausortnoel2025-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "tirageausortnoel2025",
    storageBucket: "tirageausortnoel2025.firebasestorage.app",
    messagingSenderId: "920614742305",
    appId: "1:920614742305:web:54930654b2782a07863660"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ====== LISTE DES INVITES ======
const guests = ["Martin", "Lénaëlle", "Emilie", "Patricia", "Michel", "Quentin", "Tan","Jean-Michel","Lionel","Antoine","Marie","Didier"];

// ====== FUNCTIONS ======
function updateDropdown(alreadyDrawn) {
    const select = document.getElementById("yourName");
    select.innerHTML = '';
    guests.forEach(name => {
        if (!alreadyDrawn || !alreadyDrawn[name]) {
            let option = document.createElement("option");
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
        }
    });
}

// Écoute la base de données pour la synchro
db.ref('tirage').on('value', snapshot => {
    const data = snapshot.val() || {};
    updateDropdown(data.alreadyDrawn);
});

// ====== TIRAGE AVEC ANIMATION SUSPENSE ======
document.getElementById("drawBtn").addEventListener("click", async () => {
    const select = document.getElementById("yourName");
    const yourName = select.value;
    if (!yourName) return alert("Choisis ton nom.");

    const snap = await db.ref('tirage').get();
    const data = snap.val() || {};
    const alreadyDrawn = data.alreadyDrawn || {};
    const drawnFor = data.drawnFor || {};

    // Liste des noms possibles à tirer
    let possible = guests.filter(name => name !== yourName && !Object.values(drawnFor).includes(name));
    if (possible.length === 0) {
        document.getElementById("result").textContent = "Désolé, plus personne à tirer.";
        return;
    }

    const resultDiv = document.getElementById("result");

    // ----- ANIMATION SUSPENSE -----
    function suspenseAnimation(possible, finalCallback) {
        let startTime = Date.now();
        let duration = 2000; // durée totale animation

        function animate() {
            let elapsed = Date.now() - startTime;
            if (elapsed >= duration) {
                // Choisir le nom final
                let index = Math.floor(Math.random() * possible.length);
                let drawn = possible[index];
                finalCallback(drawn);
                return;
            }

            // Nom aléatoire parmi tous les invités pour l'effet suspense
            let randomName = guests[Math.floor(Math.random() * guests.length)];

            // Variation visuelle
            resultDiv.textContent = `🎁 ${randomName} 🎁`;
            resultDiv.style.color = `hsl(${Math.random() * 360}, 100%, 40%)`;
            resultDiv.style.fontSize = 20 + Math.random() * 15 + "px";

            // Ralentissement progressif
            let progress = elapsed / duration;
            let interval = 50 + progress * 200; // commence rapide, finit lent
            setTimeout(animate, interval);
        }

        animate();
    }

    // Lancer l'animation suspense
    suspenseAnimation(possible, (drawn) => {
        // Mettre à jour Firebase
        alreadyDrawn[yourName] = true;
        drawnFor[yourName] = drawn;
        db.ref('tirage').set({alreadyDrawn, drawnFor});

        // Afficher résultat final
        resultDiv.textContent = `Tu offres un cadeau à : ${drawn} 🎁`;
        launchConfetti();
    });
});

// ====== RÉINITIALISER AVEC MOT DE PASSE ======
document.getElementById("resetBtn").addEventListener("click", () => {
    const code = prompt("🎅 Entre le mot de passe pour réinitialiser :");
    if (code !== "noel2025") {
        alert("⛔ Mot de passe incorrect !");
        return;
    }
    if (!confirm("Veux-tu vraiment tout réinitialiser ?")) return;
    db.ref('tirage').set({alreadyDrawn: {}, drawnFor: {}});
    document.getElementById("result").textContent = "";
    alert("✅ Tirage réinitialisé !");
});

// ====== CONFETTIS ======
const canvas = document.getElementById("confetti");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let confettis = [];

function createConfetti() {
    for (let i = 0; i < 150; i++) {
        confettis.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height - canvas.height,
            r: Math.random() * 6 + 4,
            d: Math.random() * 20 + 10,
            color: `hsl(${Math.random()*360}, 100%, 50%)`,
            tilt: Math.random() * 10 - 10,
            tiltAngleIncremental: Math.random() * 0.07 + 0.05,
            tiltAngle: 0
        });
    }
}

function drawConfetti() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    confettis.forEach((c, i) => {
        ctx.beginPath();
        ctx.lineWidth = c.r / 2;
        ctx.strokeStyle = c.color;
        ctx.moveTo(c.x + c.tilt + c.r / 4, c.y);
        ctx.lineTo(c.x + c.tilt, c.y + c.tilt + c.r / 4);
        ctx.stroke();
        c.tiltAngle += c.tiltAngleIncremental;
        c.y += (Math.cos(c.d) + 3 + c.r / 2) / 2;
        c.tilt = Math.sin(c.tiltAngle) * 15;
        if (c.y > canvas.height) confettis.splice(i, 1);
    });
}

function launchConfetti() {
    confettis = [];
    createConfetti();
    let confettiInterval = setInterval(() => {
        drawConfetti();
        if (confettis.length === 0) clearInterval(confettiInterval);
    }, 20);
}

window.addEventListener("resize", () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});

// ====== NEIGE ANIMÉE ======
function createSnowflake() {
    const snowflake = document.createElement("div");
    snowflake.classList.add("snowflake");
    snowflake.textContent = "❄️";
    snowflake.style.left = Math.random() * 100 + "vw";
    snowflake.style.animationDuration = 5 + Math.random() * 5 + "s";
    snowflake.style.opacity = Math.random();
    snowflake.style.fontSize = 10 + Math.random() * 20 + "px";
    document.body.appendChild(snowflake);
    setTimeout(() => snowflake.remove(), 10000);
}
setInterval(createSnowflake, 200);

</script>

<style>
.snowflake {
    position: fixed;
    top: -2em;
    z-index: 10000;
    pointer-events: none;
    animation-name: fall;
    animation-timing-function: linear;
}
@keyframes fall {
    to { transform: translateY(110vh); }
}
#version {
    position: fixed;
    bottom: 10px;
    right: 10px;
    color: #b71c1c;
    font-size: 0.9em;
    background: rgba(255, 255, 255, 0.8);
    padding: 5px 10px;
    border-radius: 10px;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
    font-weight: bold;
}
</style>

<div id="version"></div>

<script>
  // Version affichée en bas à droite
  const version = "v1.0.3"; // 🆕 change ce numéro à chaque mise à jour
  document.getElementById("version").textContent = "Version " + version;
</script>

</body>
</html>
