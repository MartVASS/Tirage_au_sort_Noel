<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tirage au sort de No√´l üéÑ</title>
<style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 2em; background-color: #f9f3f0; transition: background-color 1s ease; overflow: hidden; }
    h1 { color: #d32f2f; text-shadow: 1px 1px 2px #fff; }
    button { padding: 0.5em 1em; font-size: 1em; margin-top: 1em; cursor: pointer; border-radius: 8px; border: none; background: #d32f2f; color: white; transition: transform 0.2s; }
    button:hover { transform: scale(1.05); background: #b71c1c; }
    select { padding: 0.5em; font-size: 1em; border-radius: 6px; }
    #result { margin-top: 2em; font-size: 1.5em; color: #2e7d32; font-weight: bold; min-height: 2em; }
    canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 9999; }

    .magic-reveal {
        animation: popIn 0.6s ease forwards, glow 1.5s ease-in-out infinite alternate;
    }
    @keyframes popIn {
        0% { transform: scale(0.2); opacity: 0; }
        70% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(1); }
    }
    @keyframes glow {
        from { text-shadow: 0 0 5px #fff, 0 0 10px #d32f2f, 0 0 20px #ff5252; }
        to { text-shadow: 0 0 10px #fff, 0 0 20px #ff1744, 0 0 30px #ff5252; }
    }

    /* ‚ùÑÔ∏è √âcran d‚Äôaccueil */
    #introScreen {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: radial-gradient(circle, #fff0f0, #ffcccc);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        transition: opacity 1.5s ease;
    }
    #introScreen h1 { color: #b71c1c; font-size: 2.2em; margin-bottom: 1em; text-shadow: 0 0 10px white; }
    #introBtn {
        background: #c62828; color: white;
        padding: 1em 2em; border-radius: 12px; border: none;
        font-size: 1.2em; cursor: pointer; transition: transform 0.3s, background 0.3s;
    }
    #introBtn:hover { transform: scale(1.1); background: #b71c1c; }

    .snowflake {
        position: fixed;
        top: -2em;
        z-index: 10000;
        pointer-events: none;
        animation-name: fall;
        animation-timing-function: linear;
    }
    @keyframes fall { to { transform: translateY(110vh); } }

    #version {
        position: fixed;
        bottom: 10px;
        right: 10px;
        color: #b71c1c;
        font-size: 0.9em;
        background: rgba(255, 255, 255, 0.8);
        padding: 5px 10px;
        border-radius: 10px;
        box-shadow: 0 0 5px rgba(0,0,0,0.2);
        font-weight: bold;
    }
</style>
</head>
<body>

<!-- üéÖ √âcran d‚Äôaccueil -->
<div id="introScreen">
    <h1>üéÑ Bienvenue au tirage de No√´l üéÅ</h1>
    <button id="introBtn">Lancer la magie ‚ú®</button>
</div>

<h1>Tirage au sort de No√´l üéÑ</h1>
<p>Choisis ton nom :</p>
<select id="yourName"></select>
<br>
<button id="drawBtn">Tirer au sort</button>
<button id="resetBtn">R√©initialiser le tirage</button>

<div id="result"></div>
<canvas id="confetti"></canvas>

<!-- üîä Musique -->
<audio id="bgMusic" loop playsinline>
  <source src="christmas-party-time-249613.mp3" type="audio/mpeg">
</audio>
<button id="musicToggle" style="position: fixed; bottom: 10px; left: 10px; z-index: 10001; padding:5px 10px;">üîä Musique</button>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ====== CONFIGURATION FIREBASE ======
const firebaseConfig = {
    apiKey: "AIzaSyAFX3QpLLOw2f0JZMSOEobFk_XzRTmBmfA",
    authDomain: "tirageausortnoel2025.firebaseapp.com",
    databaseURL: "https://tirageausortnoel2025-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "tirageausortnoel2025",
    storageBucket: "tirageausortnoel2025.firebasestorage.app",
    messagingSenderId: "920614742305",
    appId: "1:920614742305:web:54930654b2782a07863660"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const guests = ["Martin", "L√©na√´lle", "Emilie", "Patricia", "Michel", "Quentin", "Tan","Jean-Michel","Lionel","Antoine","Marie","Alex","Didier"];

// ====== FONCTIONS ======
function updateDropdown(alreadyDrawn) {
    const select = document.getElementById("yourName");
    select.innerHTML = '';
    guests.forEach(name => {
        if (!alreadyDrawn || !alreadyDrawn[name]) {
            const option = document.createElement("option");
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
        }
    });
}

db.ref('tirage').on('value', snapshot => {
    const data = snapshot.val() || {};
    updateDropdown(data.alreadyDrawn);
});

// ====== ANIMATION SUSPENSE ======
document.getElementById("drawBtn").addEventListener("click", async () => {
    const select = document.getElementById("yourName");
    const yourName = select.value;
    if (!yourName) return alert("Choisis ton nom.");

    const snap = await db.ref('tirage').get();
    const data = snap.val() || {};
    const alreadyDrawn = data.alreadyDrawn || {};
    const drawnFor = data.drawnFor || {};

    let possible = guests.filter(name => name !== yourName && !Object.values(drawnFor).includes(name));
    if (possible.length === 0) {
        document.getElementById("result").textContent = "D√©sol√©, plus personne √† tirer.";
        return;
    }

    const resultDiv = document.getElementById("result");

    function suspenseAnimation(possible, finalCallback) {
        let start = Date.now();
        let duration = 2000;
        function animate() {
            let elapsed = Date.now() - start;
            if (elapsed >= duration) {
                let drawn = possible[Math.floor(Math.random() * possible.length)];
                finalCallback(drawn);
                return;
            }
            let randomName = guests[Math.floor(Math.random() * guests.length)];
            resultDiv.textContent = `üéÅ ${randomName} üéÅ`;
            resultDiv.style.color = `hsl(${Math.random() * 360}, 100%, 40%)`;
            setTimeout(animate, 50 + elapsed / 10);
        }
        animate();
    }

    suspenseAnimation(possible, (drawn) => {
        alreadyDrawn[yourName] = true;
        drawnFor[yourName] = drawn;
        db.ref('tirage').set({alreadyDrawn, drawnFor});
        resultDiv.textContent = `Tu offres un cadeau √† : ${drawn} üéÅ`;
        resultDiv.classList.add("magic-reveal");
        launchConfetti();
        document.body.style.backgroundColor = "#fff0f0";
        setTimeout(() => document.body.style.backgroundColor = "#f9f3f0", 2000);
    });
});

// ====== R√âINITIALISER AVEC MOT DE PASSE ======
document.getElementById("resetBtn").addEventListener("click", () => {
    const code = prompt("üéÖ Entre le mot de passe pour r√©initialiser :");
    if (code !== "noel2025") return alert("‚õî Mot de passe incorrect !");
    if (!confirm("Veux-tu vraiment tout r√©initialiser ?")) return;
    db.ref('tirage').set({alreadyDrawn: {}, drawnFor: {}});
    document.getElementById("result").textContent = "";
    alert("‚úÖ Tirage r√©initialis√© !");
});

// ====== CONFETTIS ======
const canvas = document.getElementById("confetti");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let confettis = [];

function createConfetti() {
    for (let i = 0; i < 150; i++) {
        confettis.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height - canvas.height,
            r: Math.random() * 6 + 4,
            color: `hsl(${Math.random()*360}, 100%, 50%)`,
            tilt: Math.random() * 10 - 10,
            tiltAngleIncremental: Math.random() * 0.07 + 0.05,
            tiltAngle: 0
        });
    }
}
function drawConfetti() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    confettis.forEach((c, i) => {
        ctx.beginPath();
        ctx.lineWidth = c.r / 2;
        ctx.strokeStyle = c.color;
        ctx.moveTo(c.x + c.tilt + c.r / 4, c.y);
        ctx.lineTo(c.x + c.tilt, c.y + c.tilt + c.r / 4);
        ctx.stroke();
        c.tiltAngle += c.tiltAngleIncremental;
        c.y += (Math.cos(c.d) + 3 + c.r / 2) / 2;
        c.tilt = Math.sin(c.tiltAngle) * 15;
        if (c.y > canvas.height) confettis.splice(i, 1);
    });
}
function launchConfetti() {
    confettis = [];
    createConfetti();
    let interval = setInterval(() => {
        drawConfetti();
        if (confettis.length === 0) clearInterval(interval);
    }, 20);
}
window.addEventListener("resize", () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});

// ====== NEIGE ======
function createSnowflake() {
    const flake = document.createElement("div");
    flake.classList.add("snowflake");
    flake.textContent = "‚ùÑÔ∏è";
    flake.style.left = Math.random() * 100 + "vw";
    flake.style.animationDuration = 5 + Math.random() * 5 + "s";
    flake.style.opacity = Math.random();
    flake.style.fontSize = 10 + Math.random() * 20 + "px";
    document.body.appendChild(flake);
    setTimeout(() => flake.remove(), 10000);
}
setInterval(createSnowflake, 200);

// ====== MUSIQUE ======
const bgMusic = document.getElementById("bgMusic");
const musicToggle = document.getElementById("musicToggle");

musicToggle.addEventListener("click", () => {
    if (bgMusic.paused) {
        bgMusic.play().catch(()=>{});
        musicToggle.textContent = "üîá Musique";
    } else {
        bgMusic.pause();
        musicToggle.textContent = "üîä Musique";
    }
});

// ====== √âCRAN D‚ÄôACCUEIL ======
document.getElementById("introBtn").addEventListener("click", async () => {
    const intro = document.getElementById("introScreen");
    intro.style.opacity = "0";
    setTimeout(() => intro.style.display = "none", 1500);
    try {
        await bgMusic.play();
        musicToggle.textContent = "üîá Musique";
    } catch (e) {
        console.log("Lecture musique diff√©r√©e sur iPhone");
    }
});
</script>

<div id="version"></div>
<script>
  const version = "v1.1.0"; 
  document.getElementById("version").textContent = "Version " + version;
</script>
</body>
</html>
